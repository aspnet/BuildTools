# default-build.yml
# Description: Defines a build phase for invoking build.sh/cmd
# Parameters:
#   agentOs: [Windows (default), Linux, macOS]
#       Used in templates to define variables which are OS specific
#   buildArgs: string
#       Additional arguments to pass to the build.sh/cmd script.
#       Note: -ci is always passed
#   beforeBuild: [steps]
#       Additional steps to run before build.sh/cmd
#   afterBuild: [steps]
#       Additional steps to run after build.sh/cmd
#   artifacts:
#      publish: (boolean)
#          Should artifacts be published
#      path: (string) the path
#          The file path to artifacts output

parameters:
  agentOs: 'Windows'
  configuration: 'Release'
  buildArgs: ''
  beforeBuild: []
  afterBuild: []
  artifacts:
    publish: true
    path: 'artifacts/build/'  # TODO: this is going to change when we converge with dotnet/arcade tooling

phases:
- phase: ${{ format('{0}_{1}', parameters.agentOs, parameters.configuration) }}
  queue:
    ${{ if eq(parameters.agentOs, 'macOS') }}:
      name: Hosted macOS Preview
    ${{ if eq(parameters.agentOs, 'Linux') }}:
      name: Hosted Linux Preview
    ${{ if eq(parameters.agentOs, 'Windows') }}:
      name: Hosted VS2017
  variables:
    param.agentOS: ${{ parameters.agentOs }}
    param.buildArgs: ${{ parameters.buildArgs }}
    param.configuration: ${{ parameters.configuration }}
    DOTNET_HOME: $(Agent.WorkFolder)/.dotnet
  steps:
  - checkout: self
    clean: true
  - ${{ parameters.beforeBuild }}
  - ${{ if eq(parameters.agentOs, 'Windows') }}:
    - script: .\build.cmd -ci /p:Configuration=$(param.configuration) $(param.buildArgs)
      displayName: Run build.cmd
  - ${{ if ne(parameters.agentOs, 'Windows') }}:
    - script: ./build.sh -ci -p:Configuration=$(param.configuration) $(param.buildArgs)
      displayName: Run build.sh
  - task: PublishTestResults@2
    displayName: Publish test results
    condition: always()
    inputs:
      testRunner: vstest
      testResultsFiles: 'artifacts/logs/**/*.trx'
  - ${{ if eq(parameters.artifacts.publish, 'true') }}:
    - task: PublishBuildArtifacts@1
      displayName: Upload artifacts
      condition: and(succeeded(), eq(variables['system.pullrequest.isfork'], false))
      inputs:
        pathtoPublish: ${{ parameters.artifacts.path }}
        artifactName: ${{ format('packages-{0}-{1}', parameters.agentOs, parameters.configuration) }}
        artifactType: Container
  - ${{ parameters.afterBuild }}

