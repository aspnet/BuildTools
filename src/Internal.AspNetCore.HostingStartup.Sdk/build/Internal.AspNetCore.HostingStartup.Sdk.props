<!--
  This file is automatically imported by NuGet into a user's project
  when it targets a single framework, or in classic (pre 2017) csproj projects.
-->
<Project TreatAsLocalProperty="TaskFolder;TaskAssembly">
  <PropertyGroup>
    <TaskFolder Condition=" '$(MSBuildRuntimeType)' == 'Core' ">netstandard1.6</TaskFolder>
    <TaskFolder Condition=" '$(MSBuildRuntimeType)' != 'Core' ">net46</TaskFolder>
    <TaskAssembly>$(MSBuildThisFileDirectory)..\tasks\$(TaskFolder)\Internal.AspNetCore.HostingStartup.Sdk.dll</TaskAssembly>
  </PropertyGroup>

  <ItemGroup>
    <Compile Remove="obj\depswork\*.*" />
  </ItemGroup>

  <!-- <UsingTask TaskName="RepoTasks.TrimDeps" AssemblyFile="$(TaskAssembly)" /> -->

  <Target Name="GenerateHostingStartupDeps" BeforeTargets="Build">
    <PropertyGroup>
      <_TemplatesDirectory>$(MSBuildThisFileDirectory)..\content\</_TemplatesDirectory>
      <_DepsOutputDirectory>$(MSBuildProjectDirectory)\$(BaseIntermediateOutputPath)</_DepsOutputDirectory>
      <_WorkingDirectory>$(_DepsOutputDirectory)\depswork</_WorkingDirectory>
    </PropertyGroup>

    <ItemGroup>
      <_TemplateFiles Include="$(MSBuildThisFileDirectory)..\content\HostingStartup\*.*" />
    </ItemGroup>

    <RemoveDir Directories="$(_WorkingDirectory)" />
    <Copy SourceFiles="@(_TemplateFiles)" DestinationFolder="$(_WorkingDirectory)" />

    <MSBuild Projects="$(_WorkingDirectory)/HostingStartup.csproj" Targets="Restore" />

    <MSBuild Projects="$(_WorkingDirectory)/HostingStartup.csproj"
             Targets="Restore;Rebuild;CollectDeps"
             Properties="DepsOutputPath=$(_DepsOutputDirectory);HostingStartupPackageName=%(HostingStartupPackageReference.Identity);HostingStartupPackageVersion=%(HostingStartupPackageReference.Version)" />

    <ItemGroup>
      <Content Include="$(_DepsOutputDirectory)%(HostingStartupPackageReference.Identity).deps.json"
               PackagePath="content\additionaldeps\%(HostingStartupPackageReference.Identity)\shared\Microsoft.NETCore.App\$(HostingStartupRuntimeFrameworkVersion)\" />
    </ItemGroup>

    <!-- <RepoTasks.TrimDeps DepsFiles="@(DepsFiles)" /> -->
  </Target>
</Project>
