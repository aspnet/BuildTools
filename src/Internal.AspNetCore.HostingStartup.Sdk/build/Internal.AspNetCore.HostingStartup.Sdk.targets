<!--
  This file is automatically imported by NuGet into a user's project
  when it targets a single framework, or in classic (pre 2017) csproj projects.
-->

<Project>

  <Target Name="GenerateHostingStartupDeps" BeforeTargets="Build">
    <PropertyGroup>
      <_TemplatesDirectory>$(MSBuildThisFileDirectory)..\content\</_TemplatesDirectory>
      <_DepsOutputDirectory>$(MSBuildProjectDirectory)\$(BaseIntermediateOutputPath)</_DepsOutputDirectory>
      <_WorkingDirectory>$(_DepsOutputDirectory)\depswork</_WorkingDirectory>
      <_BasePackagePath>content\additionaldeps\</_BasePackagePath>
    </PropertyGroup>

    <ItemGroup>
      <_TemplateFiles Include="$(MSBuildThisFileDirectory)..\content\HostingStartup\*.*" />
    </ItemGroup>

    <RemoveDir Directories="$(_DepsOutputDirectory)%(HostingStartupPackageReference.Identity)" />

    <Copy SourceFiles="@(_TemplateFiles)" DestinationFolder="$(_DepsOutputDirectory)%(HostingStartupPackageReference.Identity)" />

    <MSBuild Projects="$(_DepsOutputDirectory)%(HostingStartupPackageReference.Identity)/HostingStartup.csproj" Targets="Restore" />

    <MSBuild Projects="$(_DepsOutputDirectory)%(HostingStartupPackageReference.Identity)/HostingStartup.csproj"
             Targets="Restore;Clean;Publish"
             Properties="PublishDir=$(_DepsOutputDirectory)%(HostingStartupPackageReference.Identity);DepsOutputPath=$(_DepsOutputDirectory);HostingStartupPackageName=%(HostingStartupPackageReference.Identity);HostingStartupPackageVersion=%(HostingStartupPackageReference.Version)" />

    <ItemGroup>
      <DepsFiles
        Include="$(_DepsOutputDirectory)%(HostingStartupPackageReference.Identity)\HostingStartup.deps.json"
        DllPath="$(_DepsOutputDirectory)%(HostingStartupPackageReference.Identity)\%(HostingStartupPackageReference.Identity).dll"
        TrimmedPath="$(_DepsOutputDirectory)%(HostingStartupPackageReference.Identity)\%(HostingStartupPackageReference.Identity).deps.json"
        PackagePath="$(_BasePackagePath)%(HostingStartupPackageReference.Identity)\shared\Microsoft.NETCore.App\$(HostingStartupRuntimeFrameworkVersion)\"
        />
    </ItemGroup>

    <Copy SourceFiles="%(DepsFiles.Identity)" DestinationFiles="%(DepsFiles.TrimmedPath)" />

    <RepoTasks.TrimDeps DepsFiles="%(DepsFiles.TrimmedPath)" />

    <ItemGroup>
      <Content Include="%(DepsFiles.TrimmedPath)" PackagePath="%(DepsFiles.PackagePath)" />
      <Content Include="%(DepsFiles.DllPath)" PackagePath="$(_BasePackagePath)" />
    </ItemGroup>

  </Target>
</Project>
